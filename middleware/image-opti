const sharp = require("sharp");
const path = require("path");

const optimizeImage = (req, res, next) => {
  if (!req.file) {
    return next();
  }

  const imagePath = path.join(__dirname, "../images", req.file.filename);

  // Use sharp to optimize the image
  sharp(imagePath)
    .resize(800) // Resize to a width of 800px (maintaining aspect ratio)
    .toFormat("webp", { quality: 80 }) // Convert to JPEG and set quality
    .toFile(imagePath, (err) => {
      if (err) {
        console.error("Error processing image:", err);
        return res.status(500).json({ error: "Error processing image" });
      }
      console.log("Image processed and saved:", req.file.filename);
      next();
    });
};

module.exports = optimizeImage;
